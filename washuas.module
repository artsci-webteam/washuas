<?php

/**
 * @file
 * washuas.module
 * Drupal hooks and other helper functions for those hooks can go here
 */

use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\field\Entity\FieldStorageConfig;

/**
 * Implements hook_allowed_values_function().
 */
function washuas_rule_year_allowed_values(FieldStorageConfig $definition, ContentEntityInterface $entity = NULL, $cacheable) {
  // Available drop year values.
  $thisyear = date('Y');
  $i = $thisyear;
  $options = [];
  while ($i >= 2000) {
    $options[$i] = $i;
    $i--;
  }
  return $options;
}

/**
 * Implements hook_views_query_alter().
 */
function washuas_views_query_alter(\Drupal\views\ViewExecutable $view, \Drupal\views\Plugin\views\query\QueryPluginBase $query) {

    // Skip altering preview queries in the Views UI.
    if (\Drupal::routeMatch()->getRouteName() === 'views_ui.preview') {
        return;
    }

    // Determine if this query involves node data, whether as base or via relationship.
    $table_aliases = [];
    foreach ($query->relationships as $alias => $info) {
        if (!empty($info['table']) && $info['table'] === 'node_field_data') {
            $table_aliases[] = $alias;
        }
    }

    // If not directly found, also check the base table (in case itâ€™s not in relationships).
    if (!isset($table_aliases['node_field_data']) && $view->storage->get('base_table') === 'node_field_data') {
        $table_aliases[] = 'node_field_data';
    }

    if (!empty($table_aliases)) {
        // Only show private nodes if user has a specific permission.
        $account = \Drupal::currentUser();
        if (!$account->hasPermission('access private content')) {
            foreach ($table_aliases as $table_alias){
                // Add a condition to only show non-private content.
                // (check if private field is null or zero)
                $query->addWhereExpression(0, "coalesce($table_alias.private, 0) = 0");
            }
        }
    }
}

